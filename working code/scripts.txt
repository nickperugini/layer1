Script to create deployment package in AWS Cloudshell:

mkdir lambda_opa_py_package
cd lambda_opa_py_package/
vi lambda_function.py
ESC :set paste 
#so that no extra spaces are added when pasting into vi
#paste function:
'''
import json
from opa_wasm import OPAPolicy

# Lambda handler function
def lambda_handler(event, context):
    try:
        policy = OPAPolicy('policy.wasm')
        data_file = open('data.json')
        data = json.load(data_file)
        # Optional: Set policy data
        policy.set_data(data)
        # load the input
        input_file = open('input_object.json')
        input = json.load(input_file)
        # Evaluate the policy
        result = policy.evaluate(input)
        # [{'result': {'rule': 'C', 'label': 'UNRESTRICTED'}}]
        print(result)
        return {
            'statusCode': 200,
            'body': json.dumps(result)
        }

    except Exception as e:
        # Handle any errors and return an error response
        return {
            'statusCode': 500,
            'body': json.dumps(f"Error: {str(e)}")
        }
'''
#Press ESC, then :wq to write and quit vim
pip install wasmer -t .
pip install wasmer_compiler_cranelift -t .
pip install wasmer_compiler_llvm -t .
pip install opa_wasm -t .
zip -r ../lambda_opa_py_package.zip .
cd .. 
chmod +x lambda_opa_py_package.zip
aws s3 cp lambda_opa_py_package.zip s3://BUCKET_NAME

Script to build .wasm file from .rego ruleset:

opa build -t wasm -e test/main policy.rego
